<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>C-mcd 桐陰祭食販2025</title>
<style>
  body {
    margin: 0;
    font-family: "Comic Sans MS", cursive, sans-serif;
    background-image: url('c6dc2bb8-8ff9-4e2f-861d-c93d6039b578.png');
    background-size: cover;
    color: white;
    text-align: center;
    user-select: none;
    background: black;
    background-image: url('image/全体の流れ.png');
  }
  h1 {
    font-size: 28px;
    margin: 20px 0 40px 0;
  }
  .grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 20px;
    max-width: 900px;
    margin: 0 auto;
  }
  .box {
    background-color: #55565f;
    border: 2px solid white;
    border-radius: 4px;
    padding: 20px;
    cursor: pointer;
    font-size: 24px;
  }
  .box .number {
    font-weight: bold;
    font-size: 28px;
    margin-bottom: 10px;
  }
  .box .item {
    font-size: 18px;
  }
  /* モーダル背景 */
  #modal-bg {
    display: none;
    position: fixed;
    top: 0; left: 0; width: 100vw; height: 100vh;
    background-color: rgba(0,0,0,0.7);
    justify-content: center;
    align-items: center;
  }
  /* モーダル本体 */
  #modal {
    background-color: #222277;
    border-radius: 10px;
    padding: 30px;
    width: 320px;
    color: #fff156;
    font-weight: bold;
    font-size: 20px;
    background-image: url('image/ねこ.png');
    background-size: 100%;
  }
  #modal .title {
    font-size: 28px;
    margin-bottom: 10px;
  }
  #modal .desc {
    margin-bottom: 15px;
  }
  #modal .buttons {
    display: flex;
    justify-content: space-around;
  }
  #modal button {
    border: none;
    padding: 10px 25px;
    border-radius: 5px;
    font-style: italic;
    font-size: 18px;
    cursor: pointer;
    color: white;
  }
  #modal .btn-hey {
    background-color: #55565f;
  }
  #modal .btn-yeah {
    background-color: #ff4d4d;
  }
</style>
</head>
<body>
  <div id="login">
    <p>パスワードを入力してください。</p>
    <input type="password" id="pass" placeholder="パスワードを入力" />
    <button onclick="login()">ログイン</button>
  </div>

  <div id="main" style="display:none;">
    <h1 id="class-number-title">0組</h1><!-- じゃが☆じゃが☆ぽて△ぽて△デリシャス♪ぽていとっ！ -->

    <div class="grid" id="buttons-container">
      <!-- ボタンはJavaScriptで追加 -->
    </div>

    <!-- モーダル -->
    <div id="modal-bg" onclick="closeModal()">
      <div id="modal" onclick="event.stopPropagation()">
        <div class="title" id="modal-number"></div>
        <div class="desc" id="modal-items"></div>
        <div class="desc">受け渡ししましたか？</div>
        <div class="buttons">
          <button class="btn-hey" onclick="closeModal()">キャンセル</button>
          <button class="btn-yeah" onclick="yeahClicked()">はい</button>
        </div>
      </div>
    </div>
  </div>

<script>
const container = document.getElementById("buttons-container");
const modalBg = document.getElementById("modal-bg");
const modalNumber = document.getElementById("modal-number");
const modalItems = document.getElementById("modal-items");
const itemNames = {
  1: {item_1: "プレーン", item_2: "抹茶"},
  2: {item_1: "通常", item_2: "チーズ"},
  3: {item_1: "みたらし", item_2: "あんこ"},
  4: {item_1: "抹茶白玉小豆", item_2: "マンゴー"},
  5: {item_1: "コンソメ", item_2: "バター醤油"},
  6: {item_1: "たこ", item_2: "明太もちチーズ"},
}

const allOrdersData = {}
let classNumber = 1;
let isLogin = false;
let isOnline = navigator.onLine;
let auth_key = null;
let currentItem = null;  // 現在選択中のアイテム（モーダルを開いている番号）

const apiurl_dev = "https://didactic-space-bassoon-r4wxv7xv79w4cj5g-80.app.github.dev/";
const apiurl_production = "https://api.yaakiyu.f5.si/";

let apiurl = apiurl_production;

function tryDevApiUrlSwitch() {
  fetch(
    apiurl_dev + "version", { method: "GET", cache: "no-store" }
  ).then(res => {
    if (res.ok) {
      apiurl = apiurl_dev;
      console.warn("apiurlを開発環境に切り替えました");
    }
  }).catch(() => {
    // devサーバーが落ちている場合は何もしない
  });
}
tryDevApiUrlSwitch();


function getItemsToRender() {
  const data = [];
  for(let order_id in allOrdersData) {
    const order = allOrdersData[order_id];
    if (order.status === "調理待ち") {
      data.push({
        id: order_id,
        item_1: order.order_items["item_1"] || 0,
        item_2: order.order_items["item_2"] || 0,
      });
    }
  }
  return data;
}

function renderBoxes() {
  container.innerHTML = "";
  const data = getItemsToRender();
  // ボタン生成
  data.forEach(item => {
    const btn = document.createElement("div");
    btn.className = "box";
    btn.id = `box-${item.id}`;
    btn.innerHTML = `<div class="number">${item.id}番</div>`;
    if (item.item_1 !== 0) btn.innerHTML += `<div class="item">${itemNames[classNumber].item_1}　${item.item_1}個</div>`;
    if (item.item_2 !== 0) btn.innerHTML += `<div class="item">${itemNames[classNumber].item_2}　${item.item_2}個</div>`;
    btn.onclick = () => openModal(item);
    container.appendChild(btn);
  });
}

function openModal(item) {
  currentItem = item;
  modalNumber.textContent = `${item.id}番`;
  modalItems.innerHTML = `${itemNames[classNumber].item_1}　${item.item_1}個<br>${itemNames[classNumber].item_2}　${item.item_2}個`;
  modalBg.style.display = "flex";
}

function closeModal() {
  modalBg.style.display = "none";
  currentItem = null;
}

function yeahClicked() {
  if (!currentItem) return;

  const body = [];
  body.push({
    order_id: currentItem.id,
    status: "提供済み",
    message: null
  })
  const nextChange = calculateNextCall(currentItem.id);
  for (let i of nextChange) body.push(i);

  // ステータスを更新する
  changeStatusMulti(body);
  // 該当のボタンを消す
  const btn = document.getElementById(`box-${currentItem.id}`);
  if (btn) btn.remove();

  closeModal();
}


function changeStatusMulti(body){
  fetch(apiurl + "change_status_multi", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      authorization: auth_key,
    },
    body: JSON.stringify({body: body, from_: classNumber})
  }).then((response) => {
    if (response.status === 429) {
      const retryAfter = response.headers.get("Retry-After");
      let delay = 0;
      const sec = parseFloat(retryAfter);
      if (!isNaN(sec)) {
        delay = sec * 1000;
      } else {
        delay = 1000;
      }
      console.warn(
        `Too many requests, Retry after: ${retryAfter} (${Math.max(delay, 500)}ms)`
      );
      setTimeout(() => {
        changeStatusMulti(body);
      }, Math.max(delay, 500));
      return;
    }
    if (!response.ok){
      console.error("Error:", response.text());
      alert("リクエストエラーが発生しました。");
      return;
    }
    // データを更新する
    for (let order of body) {
      allOrdersData[order["order_id"]]["status"] = order["status"];
      allOrdersData[order["order_id"]]["history"].push({
        status: order["status"],
        timestamp: Math.floor(Date.now() / 1000),
        message: order["message"]
      });
    }
  });
}


function calculateNextCall(now_id = 0) {
  let now_call_count = 0;
  for (let order_id in allOrdersData) {
    const order = allOrdersData[order_id];
    if (order.status === "呼び出し中" || order.status === "調理待ち") {
      if (order_id === now_id) continue;
      now_call_count += order.order_items["item_1"] || 0
      now_call_count += order.order_items["item_2"] || 0
    }
  }

  const body = [];
  for (let order_id in allOrdersData) {
    const order = allOrdersData[order_id];
    if (now_call_count >= 20) break;
    if (order.status == "呼び出し待ち") {
      body.push({
        order_id: order_id,
        status: "呼び出し中",
        message: null
      });
      now_call_count += order.order_items["item_1"] || 0
      now_call_count += order.order_items["item_2"] || 0
    }
  }

  return body
}


function login() {
  const password = document.getElementById("pass").value;
  fetch(apiurl + "login", {
    method: "GET",
    headers: {
      "Content-Type": "application/json",
      password: password,
    },
  }).then(async (response) => {
    if (response.status === 401) {
      alert("パスワードが違います");
      return null;
    } else if (!response.ok) {
      alert("ログイン中にエラーが発生しました。");
      console.error("Error: ", response.status, await response.json());
      return null;
    }

    const data = await response.json();
    console.log(data);
    isLogin = true;
    auth_key = data["token"];
    classNumber = data["user"];

    document.getElementById("pass").value = "";
    document.title = `[${classNumber}組] C-mcd 桐陰祭食販2025`;
    document.getElementById("class-number-title").textContent = `${classNumber}組`;
    document.getElementById("login").style.display = "none";
    document.getElementById("main").style.display = "block";

    const checkInterval = () => {
      check().then((ret) => {
        let update_count = 0;
        for (const key in ret) {
          const order_id = ret[key]["order_id"];
          if (ret[key]["id"] < 7) continue; // 在庫管理用IDなので無視
          if (!allOrdersData[order_id]) {
            allOrdersData[order_id] = {
              ordered_at: Number(ret[key]["timestamp"]) * 1000,
              order_items: ret[key]["order_items"],
              status: ret[key]["status"],
              history: [ret[key]],
            };
          } else {
            allOrdersData[order_id]["status"] = ret[key]["status"];
            allOrdersData[order_id]["history"].push(ret[key]);
          }
          update_count++;
        }

        if (update_count > 0) {
          renderBoxes();
        }

        const body = [];
        const nexts = calculateNextCall();
        for (let i of nexts) body.push(i);

        for (const order_id in allOrdersData) {
          const order = allOrdersData[order_id];
          if (order.status === "呼び出し中") {
            const timestamp = order.history[order.history.length - 1].timestamp;
            if (Date.now() - timestamp * 1000 > 15 * 60 * 1000) {
              // タイムアウト、自動キャンセル
              body.push({
                order_id: order_id, status: "キャンセル済み", message: null
              });
            }
          }
        }
        if (body) changeStatusMulti(body);

        setTimeout(() => {if (isLogin) {checkInterval();}}, 1000);
      }).catch((error) => {
        console.error(error);
        alert("リクエストエラーが発生しました。");
      });
    };

    fetch(apiurl + "log_all", {
      method: "GET",
      headers: {
        "Content-Type": "application/json",
        authorization: auth_key,
      },
    }).then(async (response) => {
      if (response.status === 200) {
        const ret = await response.json();
        for (const key in ret) {
          if (ret[key]["id"] < 7) continue; // 在庫管理用IDなので無視
          allOrdersData[key] = {
            order_items: ret[key]["order_items"],
            status: ret[key]["status"],
            ordered_at: Number(ret[key]["history"][0]["timestamp"]) * 1000,
            history: ret[key]["history"],
          };
        }
        renderBoxes();
      } else {
        console.error("Error:", await response.text());
        return;
      }
    });

    checkInterval();
    console.log("checkInterval start");
  }).catch((error) => {
    console.error(error);
    alert("ログイン中にエラーが発生しました。");
  });
}

function check() {
  return fetch(apiurl + "check", {
    method: "GET",
    headers: {
      "Content-Type": "application/json",
      authorization: auth_key,
    },
  }).then(async (response) => {
    if (response.status === 200) {
      return await response.json();
    } else {
      console.error("Error:", await response.text());
      return null;
    }
  });
}
</script>
</body>
</html>